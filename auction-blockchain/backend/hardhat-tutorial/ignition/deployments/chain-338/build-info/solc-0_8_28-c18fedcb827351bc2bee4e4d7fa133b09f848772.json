{
  "_format": "hh3-sol-build-info-1",
  "id": "solc-0_8_28-c18fedcb827351bc2bee4e4d7fa133b09f848772",
  "solcVersion": "0.8.28",
  "solcLongVersion": "0.8.28+commit.7893614a",
  "userSourceNameMap": {
    "contracts/Auction.sol": "project/contracts/Auction.sol"
  },
  "input": {
    "language": "Solidity",
    "settings": {
      "evmVersion": "cancun",
      "optimizer": {
        "enabled": true,
        "runs": 200
      },
      "outputSelection": {
        "*": {
          "": [
            "ast"
          ],
          "*": [
            "abi",
            "evm.bytecode",
            "evm.deployedBytecode",
            "evm.methodIdentifiers",
            "metadata"
          ]
        }
      },
      "remappings": []
    },
    "sources": {
      "project/contracts/Auction.sol": {
        "content": "// SPDX-License-Identifier: MIT\r\npragma solidity ^0.8.19;\r\n\r\ncontract Auction {\r\n    struct AuctionItem {\r\n        uint256 id;\r\n        string name;\r\n        string description;\r\n        string imageUrl;\r\n        uint256 startingPrice;\r\n        uint256 currentPrice;\r\n        uint256 endTime;\r\n        address payable seller;\r\n        address payable highestBidder;\r\n        bool isActive;\r\n        bool isCompleted;\r\n    }\r\n\r\n    struct Bid {\r\n        address bidder;\r\n        uint256 amount;\r\n        uint256 timestamp;\r\n    }\r\n\r\n    mapping(uint256 => AuctionItem) public auctions;\r\n    mapping(uint256 => Bid[]) public auctionBids;\r\n    mapping(uint256 => mapping(address => uint256)) public pendingReturns;\r\n    \r\n    uint256 public auctionCounter;\r\n    uint256 public platformFeePercent = 2; // 2% phí nền tảng\r\n    address payable public owner;\r\n\r\n    event AuctionCreated(uint256 indexed auctionId, string name, uint256 startingPrice, uint256 endTime);\r\n    event BidPlaced(uint256 indexed auctionId, address indexed bidder, uint256 amount);\r\n    event AuctionEnded(uint256 indexed auctionId, address winner, uint256 finalPrice);\r\n    event FundsWithdrawn(address indexed user, uint256 amount);\r\n\r\n    modifier onlyOwner() {\r\n        require(msg.sender == owner, \"Only owner can call this\");\r\n        _;\r\n    }\r\n\r\n    constructor() {\r\n        owner = payable(msg.sender);\r\n    }\r\n\r\n    function createAuction(\r\n        string memory _name,\r\n        string memory _description,\r\n        string memory _imageUrl,\r\n        uint256 _startingPrice,\r\n        uint256 _duration\r\n    ) external {\r\n        require(_startingPrice > 0, \"Starting price must be greater than 0\");\r\n        require(_duration >= 300, \"Duration must be at least 5 minutes\");\r\n\r\n        uint256 auctionId = auctionCounter++;\r\n        \r\n        auctions[auctionId] = AuctionItem({\r\n            id: auctionId,\r\n            name: _name,\r\n            description: _description,\r\n            imageUrl: _imageUrl,\r\n            startingPrice: _startingPrice,\r\n            currentPrice: _startingPrice,\r\n            endTime: block.timestamp + _duration,\r\n            seller: payable(msg.sender),\r\n            highestBidder: payable(address(0)),\r\n            isActive: true,\r\n            isCompleted: false\r\n        });\r\n\r\n        emit AuctionCreated(auctionId, _name, _startingPrice, block.timestamp + _duration);\r\n    }\r\n\r\n    function placeBid(uint256 _auctionId) external payable {\r\n        AuctionItem storage auction = auctions[_auctionId];\r\n        \r\n        require(auction.isActive, \"Auction is not active\");\r\n        require(block.timestamp < auction.endTime, \"Auction has ended\");\r\n        require(msg.sender != auction.seller, \"Seller cannot bid\");\r\n        require(msg.value > auction.currentPrice, \"Bid must be higher than current price\");\r\n\r\n        // Hoàn tiền cho người đặt giá cao nhất trước đó\r\n        if (auction.highestBidder != address(0)) {\r\n            pendingReturns[_auctionId][auction.highestBidder] += auction.currentPrice;\r\n        }\r\n\r\n        // Cập nhật thông tin đấu giá\r\n        auction.currentPrice = msg.value;\r\n        auction.highestBidder = payable(msg.sender);\r\n\r\n        // Lưu lịch sử bid\r\n        auctionBids[_auctionId].push(Bid({\r\n            bidder: msg.sender,\r\n            amount: msg.value,\r\n            timestamp: block.timestamp\r\n        }));\r\n\r\n        emit BidPlaced(_auctionId, msg.sender, msg.value);\r\n    }\r\n\r\n    function endAuction(uint256 _auctionId) external {\r\n        AuctionItem storage auction = auctions[_auctionId];\r\n        \r\n        require(auction.isActive, \"Auction is not active\");\r\n        require(block.timestamp >= auction.endTime, \"Auction has not ended yet\");\r\n\r\n        auction.isActive = false;\r\n        auction.isCompleted = true;\r\n\r\n        // Nếu có người thắng\r\n        if (auction.highestBidder != address(0)) {\r\n            // Tính phí nền tảng\r\n            uint256 platformFee = (auction.currentPrice * platformFeePercent) / 100;\r\n            uint256 sellerAmount = auction.currentPrice - platformFee;\r\n\r\n            // Chuyển tiền cho người bán\r\n            auction.seller.transfer(sellerAmount);\r\n            // Chuyển phí cho nền tảng\r\n            owner.transfer(platformFee);\r\n\r\n            emit AuctionEnded(_auctionId, auction.highestBidder, auction.currentPrice);\r\n        } else {\r\n            emit AuctionEnded(_auctionId, address(0), 0);\r\n        }\r\n    }\r\n\r\n    function withdraw(uint256 _auctionId) external {\r\n        uint256 amount = pendingReturns[_auctionId][msg.sender];\r\n        require(amount > 0, \"No funds to withdraw\");\r\n\r\n        pendingReturns[_auctionId][msg.sender] = 0;\r\n        payable(msg.sender).transfer(amount);\r\n\r\n        emit FundsWithdrawn(msg.sender, amount);\r\n    }\r\n\r\n    function getAuction(uint256 _auctionId) external view returns (AuctionItem memory) {\r\n        return auctions[_auctionId];\r\n    }\r\n\r\n    function getAuctionBids(uint256 _auctionId) external view returns (Bid[] memory) {\r\n        return auctionBids[_auctionId];\r\n    }\r\n\r\n    function getAllActiveAuctions() external view returns (AuctionItem[] memory) {\r\n        uint256 activeCount = 0;\r\n        \r\n        // Đếm số đấu giá đang hoạt động\r\n        for (uint256 i = 0; i < auctionCounter; i++) {\r\n            if (auctions[i].isActive && block.timestamp < auctions[i].endTime) {\r\n                activeCount++;\r\n            }\r\n        }\r\n\r\n        AuctionItem[] memory activeAuctions = new AuctionItem[](activeCount);\r\n        uint256 index = 0;\r\n\r\n        for (uint256 i = 0; i < auctionCounter; i++) {\r\n            if (auctions[i].isActive && block.timestamp < auctions[i].endTime) {\r\n                activeAuctions[index] = auctions[i];\r\n                index++;\r\n            }\r\n        }\r\n\r\n        return activeAuctions;\r\n    }\r\n\r\n    function getPendingReturn(uint256 _auctionId, address _user) external view returns (uint256) {\r\n        return pendingReturns[_auctionId][_user];\r\n    }\r\n\r\n    function updatePlatformFee(uint256 _newFeePercent) external onlyOwner {\r\n        require(_newFeePercent <= 10, \"Fee cannot exceed 10%\");\r\n        platformFeePercent = _newFeePercent;\r\n    }\r\n\r\n    receive() external payable {}\r\n}"
      }
    }
  }
}